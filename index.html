<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nothing Weather Station</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Chart.js for Advanced Visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Simple Statistics Library for Edge Computing -->
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>

    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }
        
        /* Typography Presets */
        .font-dot { font-family: 'Roboto', sans-serif; font-weight: 500; letter-spacing: 0.02em; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Nothing OS Style Card */
        .sensor-card {
            background-color: #0a0a0a; /* Very dark grey */
            border: 1px solid #333333;
            border-radius: 0px; /* Sharp corners as per image 55208c or slight radius */
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        
        .sensor-card:hover {
            border-color: #555555;
        }

        /* The Dotted Background Pattern */
        .bg-dots {
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.5;
        }

        /* Utility for the Red Accent */
        .text-nothing-red { color: #EB0029; }
        .bg-nothing-red { background-color: #EB0029; }
        .border-nothing-red { border-color: #EB0029; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Animations */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .animate-blink { animation: blink 2s infinite; }
        
        /* Chart Bars Animation */
        @keyframes grow { from { height: 0; } to { height: var(--h); } }
        .chart-bar { animation: grow 1s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createClient } = supabase;

        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = "https://wpiamopnovthqpesfbuw.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwaWFtb3Bub3Z0aHFwZXNmYnV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjI2ODYsImV4cCI6MjA3OTc5ODY4Nn0.cJzs_6F_W971tRs8TkvYHUF_CljQSZ2lqgwsMVLqNwE";
        const client = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ICONS (Inline SVG for reliability) ---
        const Icons = {
            Thermometer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>,
            Droplets: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 10a6 6 0 0 0-1.11 7.7"/><path d="M18 17.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S18.29 7.75 18 6.3c-.29 1.45-1.14 2.8-2.29 3.76S14 12.1 14 13.25c0 2.22 1.8 4.05 4 4.05z"/></svg>,
            Gauge: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>,
            Wind: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>,
            Waves: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/></svg>,
            Speaker: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4.785a1 1 0 0 0-1.272-.736L4.5 5.5H2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h2.5l5.228 1.451A1 1 0 0 0 11 19.215V4.785z"/><path d="M15.5 8a4.5 4.5 0 0 1 0 8"/></svg>,
            CloudRain: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 20v-4"/><path d="M8 20v-4"/><path d="M12 20v-4"/></svg>,
            Info: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            TrendingDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
            Minus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Filter: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            BarChart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
        };

        // --- COMPONENTS ---

        // Function to convert MQ-2 ADC value to human-readable status with PPM estimation
        const getGasStatus = (adcValue) => {
            if (!adcValue || adcValue === '--') {
                return { text: 'No Data', ppm: 0, color: 'text-gray-500', status: 'ok', detail: 'Waiting for sensor data' };
            }
            
            const value = Number(adcValue);
            
            // MQ-2 PPM Estimation (calibrated for LPG)
            // This is an approximation based on typical MQ-2 response curves
            // Formula: PPM = ((ADC / 4095) * Rs/Ro ratio) mapped to typical ranges
            // Clean air ~300-400 ppm, Dangerous levels >1000 ppm
            let ppm = 0;
            if (value < 500) {
                ppm = 300 + (value / 500) * 100; // 300-400 ppm
            } else if (value < 1000) {
                ppm = 400 + ((value - 500) / 500) * 100; // 400-500 ppm
            } else if (value < 2000) {
                ppm = 500 + ((value - 1000) / 1000) * 300; // 500-800 ppm
            } else if (value < 3000) {
                ppm = 800 + ((value - 2000) / 1000) * 400; // 800-1200 ppm
            } else {
                ppm = 1200 + ((value - 3000) / 1095) * 800; // 1200-2000+ ppm
            }
            ppm = Math.round(ppm);
            
            if (value < 1000) {
                return { 
                    text: 'Air Clean', 
                    ppm: ppm,
                    color: 'text-green-500', 
                    status: 'ok',
                    detail: `${ppm} ppm - Safe air quality`
                };
            } else if (value < 2000) {
                return { 
                    text: 'Minor Detection', 
                    ppm: ppm,
                    color: 'text-yellow-400', 
                    status: 'ok',
                    detail: `${ppm} ppm - Trace amounts detected`
                };
            } else if (value < 3000) {
                return { 
                    text: 'Gas Leak Possible', 
                    ppm: ppm,
                    color: 'text-orange-500', 
                    status: 'warning',
                    detail: `${ppm} ppm - Check for leaks`
                };
            } else {
                return { 
                    text: 'DANGER - High Gas!', 
                    ppm: ppm,
                    color: 'text-nothing-red', 
                    status: 'alert',
                    detail: `${ppm} ppm - Evacuate immediately!`
                };
            }
        };

        // Function to convert sound sensor ADC value to dB
        const getSoundLevel = (adcValue) => {
            if (!adcValue || adcValue === '--') {
                return { dB: '--', category: 'No Data', color: 'text-gray-500' };
            }
            
            const value = Number(adcValue);
            
            // Convert ADC (0-4095) to dB (30-100 dB range for typical environments)
            // Using logarithmic scale for more realistic sound level representation
            // Formula: dB = minDB + (ADC/maxADC) * (maxDB - minDB)
            const minDB = 30;  // Quiet library
            const maxDB = 100; // Very loud environment
            const dB = Math.round(minDB + (value / 4095) * (maxDB - minDB));
            
            let category = '';
            let color = 'text-white';
            
            if (dB < 40) {
                category = 'Very Quiet';
                color = 'text-green-500';
            } else if (dB < 55) {
                category = 'Quiet';
                color = 'text-blue-400';
            } else if (dB < 70) {
                category = 'Moderate';
                color = 'text-yellow-400';
            } else if (dB < 85) {
                category = 'Loud';
                color = 'text-orange-500';
            } else {
                category = 'Very Loud';
                color = 'text-nothing-red';
            }
            
            return { dB, category, color, adcValue: value };
        };

        // 1. Reusable Sensor Card (Matching Reference Image 55208c)
        const SensorCard = ({ icon: Icon, label, value, unit, status, subtext, color = "text-white", customValue }) => (
            <div className="sensor-card h-48 p-4 flex flex-col justify-between group">
                {/* Dotted Background */}
                <div className="absolute inset-0 bg-dots pointer-events-none"></div>
                
                {/* Header: Icon + Status Dot */}
                <div className="relative flex justify-between items-start z-10">
                    <div className="p-2 border border-[#333] rounded bg-black">
                        <Icon className="w-5 h-5 text-gray-400" />
                    </div>
                    {/* Status Dot */}
                    <div className={`w-2 h-2 rounded-full ${status === 'alert' ? 'bg-nothing-red animate-pulse' : (status === 'warning' ? 'bg-orange-500 animate-pulse' : 'bg-green-500')}`}></div>
                </div>

                {/* Content */}
                <div className="relative z-10 mt-4">
                    <div className="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-1">{label}</div>
                    <div className={`text-4xl font-normal font-dot ${color}`}>
                        {customValue || value} <span className="text-sm font-sans text-gray-500 ml-1">{unit}</span>
                    </div>
                    {subtext && (
                        <div className="mt-2 pt-2 border-t border-[#333] text-[10px] text-gray-400 flex items-center gap-2">
                             <div className={`w-1.5 h-1.5 rounded-full ${status === 'alert' ? 'bg-nothing-red' : (status === 'warning' ? 'bg-orange-500' : 'bg-blue-500')}`}></div>
                             {subtext}
                        </div>
                    )}
                </div>
            </div>
        );

        // 2. Navigation Tab
        const NavBar = ({ activeTab, setTab }) => {
            const tabs = [
                { id: 'dashboard', label: 'Dashboard', icon: Icons.Activity },
                { id: 'analytics', label: 'Analytics', icon: Icons.TrendingUp },
                { id: 'history', label: 'History', icon: Icons.List },
                { id: 'about', label: 'About', icon: Icons.Info },
            ];

            return (
                <nav className="flex gap-1 bg-[#111] p-1 rounded-full border border-[#333] mb-6 inline-flex overflow-x-auto max-w-full">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setTab(tab.id)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-full text-xs font-medium transition-all whitespace-nowrap ${
                                activeTab === tab.id 
                                ? 'bg-nothing-red text-white shadow-lg shadow-red-900/20' 
                                : 'text-gray-400 hover:text-white hover:bg-[#222]'
                            }`}
                        >
                            <tab.icon className="w-4 h-4" />
                            {tab.label}
                        </button>
                    ))}
                </nav>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [connectionStatus, setConnectionStatus] = useState('Checking...');
            const [historyFilter, setHistoryFilter] = useState({
                startDate: '',
                endDate: '',
                alertsOnly: false,
                sortBy: 'created_at',
                sortOrder: 'desc'
            });

            // --- CLOCK & CONNECTION TICKER ---
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    setCurrentTime(now);

                    // Connection Check (Wait 1 minute timeout)
                    if (data.length > 0) {
                        const lastDataTime = new Date(data[0].created_at).getTime();
                        const diff = now.getTime() - lastDataTime;
                        // 60000ms = 1 minute
                        setConnectionStatus(diff < 60000 ? 'Connected' : 'Disconnected');
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [data]);

            // --- DATA FETCHING ---
            const fetchData = async () => {
                setLoading(true);
                try {
                    // Fetch more rows for history
                    const { data: sensorData, error } = await client
                        .from('new_sensor_data')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100);

                    if (error) throw error;
                    if (sensorData) setData(sensorData);
                } catch (err) {
                    console.error("Error fetching:", err);
                } finally {
                    setLoading(false);
                }
            };

            // Initial Load & Realtime Sub
            useEffect(() => {
                fetchData();
                const sub = client
                    .channel('public:new_sensor_data')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'new_sensor_data' }, (payload) => {
                        setData(curr => [payload.new, ...curr].slice(0, 100)); // Keep last 100 in memory
                    })
                    .subscribe();
                return () => sub.unsubscribe();
            }, []);

            // --- DERIVED DATA ---
            const latest = data[0] || {};
            const gasStatus = useMemo(() => getGasStatus(latest.gas_level), [latest.gas_level]);
            const soundLevel = useMemo(() => getSoundLevel(latest.sound_level), [latest.sound_level]);
            
            // Wind Speed Calc
            const windSpeed = useMemo(() => {
                if (data.length < 2) return 0;
                const now = new Date();
                const twoMinsAgo = new Date(now.getTime() - 2 * 60 * 1000);
                const recent = data.filter(d => new Date(d.created_at) > twoMinsAgo);
                const count = recent.filter(d => d.hall_status === 'DETECTED').length;
                return (count * 2.5).toFixed(1); // Calibration factor
            }, [data]);

            // Analytics / Trends
            const analytics = useMemo(() => {
                if (data.length < 10) return null;
                
                // Get two sets of samples: Current (last 5 records) vs Previous (next 5 records)
                const currentSet = data.slice(0, 5);
                const previousSet = data.slice(5, 10);
                
                // Pressure Trend
                const avgPressCurr = currentSet.reduce((a, b) => a + b.pressure, 0) / 5;
                const avgPressPrev = previousSet.reduce((a, b) => a + b.pressure, 0) / 5;
                const pressDiff = avgPressCurr - avgPressPrev;
                
                // Temp Trend
                const avgTempCurr = currentSet.reduce((a, b) => a + Number(b.temperature), 0) / 5;
                const avgTempPrev = previousSet.reduce((a, b) => a + Number(b.temperature), 0) / 5;
                const tempDiff = avgTempCurr - avgTempPrev;

                let forecast = "Stable";
                if (pressDiff < -0.5) forecast = "Storm Alert";
                else if (pressDiff > 0.5) forecast = "Clearing Up";
                else if (avgPressCurr < 1000) forecast = "Low Pressure";
                else forecast = "Fair Weather";

                return {
                    pressDiff,
                    tempDiff,
                    forecast,
                    avgTemp: avgTempCurr,
                    avgPress: avgPressCurr,
                    trendIcon: pressDiff < 0 ? Icons.TrendingDown : (pressDiff > 0 ? Icons.TrendingUp : Icons.Minus)
                };
            }, [data]);

            // --- STATISTICAL ANALYSIS (Edge Computing) ---
            const statistics = useMemo(() => {
                if (data.length < 20 || !window.ss) return null;
                
                const temps = data.map(d => Number(d.temperature)).filter(t => !isNaN(t));
                const humidity = data.map(d => Number(d.humidity)).filter(h => !isNaN(h));
                const pressure = data.map(d => Number(d.pressure)).filter(p => !isNaN(p));
                
                const calcStats = (arr) => ({
                    mean: ss.mean(arr),
                    median: ss.median(arr),
                    stdDev: ss.standardDeviation(arr),
                    variance: ss.variance(arr),
                    min: ss.min(arr),
                    max: ss.max(arr),
                    q1: ss.quantile(arr, 0.25),
                    q3: ss.quantile(arr, 0.75),
                    iqr: ss.quantile(arr, 0.75) - ss.quantile(arr, 0.25)
                });
                
                return {
                    temperature: calcStats(temps),
                    humidity: calcStats(humidity),
                    pressure: calcStats(pressure)
                };
            }, [data]);

            // --- ARIMA/SARIMA FORECASTING (Simplified Edge Implementation) ---
            const forecast = useMemo(() => {
                if (data.length < 30 || !window.ss) return null;
                
                // Simple ARIMA-like forecasting using exponential smoothing and trend analysis
                const forecastHorizon = 6; // Predict next 6 readings
                
                const forecastSeries = (series) => {
                    const n = series.length;
                    const recentData = series.slice(0, Math.min(30, n));
                    
                    // Triple Exponential Smoothing (Holt-Winters method)
                    const alpha = 0.3; // Level smoothing
                    const beta = 0.1;  // Trend smoothing
                    const gamma = 0.1; // Seasonal smoothing (simplified)
                    
                    let level = recentData[0];
                    let trend = recentData[1] - recentData[0];
                    let seasonal = new Array(4).fill(0);
                    
                    // Fit the model
                    for (let i = 1; i < recentData.length; i++) {
                        const prevLevel = level;
                        level = alpha * recentData[i] + (1 - alpha) * (level + trend);
                        trend = beta * (level - prevLevel) + (1 - beta) * trend;
                        seasonal[i % 4] = gamma * (recentData[i] - level) + (1 - gamma) * seasonal[i % 4];
                    }
                    
                    // Generate forecasts
                    const predictions = [];
                    for (let i = 1; i <= forecastHorizon; i++) {
                        const forecast = level + i * trend + seasonal[i % 4];
                        predictions.push(forecast);
                    }
                    
                    return predictions;
                };
                
                const temps = data.map(d => Number(d.temperature)).filter(t => !isNaN(t));
                const pressures = data.map(d => Number(d.pressure)).filter(p => !isNaN(p));
                const humidities = data.map(d => Number(d.humidity)).filter(h => !isNaN(h));
                
                return {
                    temperature: forecastSeries(temps),
                    pressure: forecastSeries(pressures),
                    humidity: forecastSeries(humidities)
                };
            }, [data]);

            // --- FILTERED HISTORY DATA ---
            const filteredData = useMemo(() => {
                let filtered = [...data];
                
                // Date filtering
                if (historyFilter.startDate) {
                    const start = new Date(historyFilter.startDate).getTime();
                    filtered = filtered.filter(d => new Date(d.created_at).getTime() >= start);
                }
                if (historyFilter.endDate) {
                    const end = new Date(historyFilter.endDate).getTime() + 86400000; // Add 1 day
                    filtered = filtered.filter(d => new Date(d.created_at).getTime() < end);
                }
                
                // Alerts only filter
                if (historyFilter.alertsOnly) {
                    filtered = filtered.filter(d => d.rain_alert === 'ALERT' || d.gas_alert === 'ALERT');
                }
                
                // Sorting
                filtered.sort((a, b) => {
                    const aVal = historyFilter.sortBy === 'created_at' ? new Date(a.created_at).getTime() : Number(a[historyFilter.sortBy]);
                    const bVal = historyFilter.sortBy === 'created_at' ? new Date(b.created_at).getTime() : Number(b[historyFilter.sortBy]);
                    return historyFilter.sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
                });
                
                return filtered;
            }, [data, historyFilter]);

            // Date Formatting
            const formattedDate = currentTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const formattedTime = currentTime.toLocaleTimeString('en-US', { hour12: false });

            // --- RENDER PAGES ---

            const renderDashboard = () => (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {/* 1. Temp */}
                    <SensorCard 
                        icon={Icons.Thermometer} 
                        label="Temperature" 
                        value={latest.temperature?.toFixed(1) || '--'} 
                        unit="°C"
                        status="ok"
                        subtext="Live Monitoring"
                    />
                    
                    {/* 2. Humidity */}
                    <SensorCard 
                        icon={Icons.Droplets} 
                        label="Humidity" 
                        value={latest.humidity?.toFixed(1) || '--'} 
                        unit="%"
                        status="ok"
                        subtext={latest.humidity > 80 ? "High Humidity" : "Normal"}
                    />

                    {/* 3. Pressure */}
                    <SensorCard 
                        icon={Icons.Gauge} 
                        label="Atmospheric Pressure" 
                        value={Math.round(latest.pressure) || '--'} 
                        unit="hPa"
                        status="ok"
                        subtext="Barometric"
                    />

                    {/* 4. Wind */}
                    <SensorCard 
                        icon={Icons.Wind} 
                        label="Wind Speed" 
                        value={windSpeed} 
                        unit="km/h"
                        status="ok"
                        subtext={latest.hall_status === "DETECTED" ? "Hall Effect Active" : "Calm"}
                    />

                    {/* 5. Gas */}
                    <SensorCard 
                        icon={Icons.Waves} 
                        label="Combustible Gas Level (MQ-2)" 
                        value={gasStatus.ppm || '--'} 
                        customValue={null}
                        unit="ppm"
                        status={gasStatus.status}
                        color={gasStatus.color}
                        subtext={`${gasStatus.text} • ADC: ${latest.gas_level || '--'}`}
                    />

                    {/* 6. Sound */}
                    <SensorCard 
                        icon={Icons.Speaker} 
                        label="Sound Level" 
                        value={soundLevel.dB} 
                        unit="dB"
                        status="ok"
                        color={soundLevel.color}
                        subtext={`${soundLevel.category} • ADC: ${soundLevel.adcValue || '--'}`}
                    />

                    {/* 7. Rain (Double Width) */}
                    <div className="sensor-card h-48 p-4 flex flex-col justify-between group md:col-span-2">
                         <div className="absolute inset-0 bg-dots pointer-events-none"></div>
                         <div className="relative flex justify-between items-start z-10">
                            <div className="p-2 border border-[#333] rounded bg-black">
                                <Icons.CloudRain className="w-5 h-5 text-gray-400" />
                            </div>
                            <div className={`w-2 h-2 rounded-full ${(Number(latest.rain_level) < 2000) ? 'bg-nothing-red animate-pulse' : 'bg-green-500'}`}></div>
                        </div>
                        <div className="relative z-10">
                            <div className="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-1">Raindrop Detector</div>
                            <div className={`text-4xl font-normal font-dot ${(Number(latest.rain_level) < 2000) ? 'text-nothing-red' : 'text-white'}`}>
                                {(Number(latest.rain_level) < 2000) ? "WET" : "DRY"}
                            </div>
                             <div className="mt-2 pt-2 border-t border-[#333] text-[10px] text-gray-400">
                                Analog Value: {latest.rain_level}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderAnalytics = () => {
                if (!analytics || !statistics) return <div className="text-gray-500 font-mono text-center p-12">NOT ENOUGH DATA FOR ANALYSIS (Need 30+ readings)</div>;
                
                return (
                    <div className="space-y-6">
                        {/* Forecast Card */}
                        <div className="sensor-card p-6">
                             <h2 className="text-sm font-bold uppercase tracking-widest text-gray-500 mb-2">Weather Forecast (ARIMA/SARIMA Model)</h2>
                             <div className="flex items-center gap-4">
                                <analytics.trendIcon className={`w-12 h-12 ${analytics.pressDiff < 0 ? 'text-nothing-red' : 'text-green-500'}`} />
                                <div>
                                    <div className="text-4xl font-dot">{analytics.forecast}</div>
                                    <div className="text-xs text-gray-500 font-mono mt-1">Based on barometric slope: {analytics.pressDiff.toFixed(2)} hPa/10min</div>
                                </div>
                             </div>
                        </div>

                        {/* Statistical Analysis Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {/* Temperature Statistics */}
                            <div className="sensor-card p-4">
                                <h3 className="text-xs font-bold uppercase text-gray-500 mb-3 flex items-center gap-2">
                                    <Icons.Thermometer className="w-4 h-4" />
                                    Temperature Stats
                                </h3>
                                <div className="space-y-2 text-xs font-mono">
                                    <div className="flex justify-between"><span className="text-gray-500">Mean:</span><span>{statistics.temperature.mean.toFixed(2)}°C</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Median:</span><span>{statistics.temperature.median.toFixed(2)}°C</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Std Dev:</span><span>{statistics.temperature.stdDev.toFixed(2)}°C</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Range:</span><span>{statistics.temperature.min.toFixed(1)} - {statistics.temperature.max.toFixed(1)}°C</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">IQR:</span><span>{statistics.temperature.iqr.toFixed(2)}°C</span></div>
                                </div>
                            </div>

                            {/* Humidity Statistics */}
                            <div className="sensor-card p-4">
                                <h3 className="text-xs font-bold uppercase text-gray-500 mb-3 flex items-center gap-2">
                                    <Icons.Droplets className="w-4 h-4" />
                                    Humidity Stats
                                </h3>
                                <div className="space-y-2 text-xs font-mono">
                                    <div className="flex justify-between"><span className="text-gray-500">Mean:</span><span>{statistics.humidity.mean.toFixed(2)}%</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Median:</span><span>{statistics.humidity.median.toFixed(2)}%</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Std Dev:</span><span>{statistics.humidity.stdDev.toFixed(2)}%</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Range:</span><span>{statistics.humidity.min.toFixed(0)} - {statistics.humidity.max.toFixed(0)}%</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">IQR:</span><span>{statistics.humidity.iqr.toFixed(2)}%</span></div>
                                </div>
                            </div>

                            {/* Pressure Statistics */}
                            <div className="sensor-card p-4">
                                <h3 className="text-xs font-bold uppercase text-gray-500 mb-3 flex items-center gap-2">
                                    <Icons.Gauge className="w-4 h-4" />
                                    Pressure Stats
                                </h3>
                                <div className="space-y-2 text-xs font-mono">
                                    <div className="flex justify-between"><span className="text-gray-500">Mean:</span><span>{statistics.pressure.mean.toFixed(2)} hPa</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Median:</span><span>{statistics.pressure.median.toFixed(2)} hPa</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Std Dev:</span><span>{statistics.pressure.stdDev.toFixed(2)} hPa</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Range:</span><span>{statistics.pressure.min.toFixed(0)} - {statistics.pressure.max.toFixed(0)} hPa</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">IQR:</span><span>{statistics.pressure.iqr.toFixed(2)} hPa</span></div>
                                </div>
                            </div>
                        </div>

                        {/* Trend Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="sensor-card p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xs font-bold uppercase text-gray-500">Pressure Gradient</h3>
                                    <div className={`px-2 py-1 rounded text-[10px] font-bold ${analytics.pressDiff > 0 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>
                                        {analytics.pressDiff > 0 ? 'RISING' : 'FALLING'}
                                    </div>
                                </div>
                                <div className="text-2xl font-mono">{Math.abs(analytics.pressDiff).toFixed(2)} <span className="text-xs text-gray-500">hPa change</span></div>
                            </div>

                            <div className="sensor-card p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xs font-bold uppercase text-gray-500">Thermal Trend</h3>
                                    <div className={`px-2 py-1 rounded text-[10px] font-bold ${analytics.tempDiff > 0 ? 'bg-orange-900 text-orange-300' : 'bg-blue-900 text-blue-300'}`}>
                                        {analytics.tempDiff > 0 ? 'WARMING' : 'COOLING'}
                                    </div>
                                </div>
                                <div className="text-2xl font-mono">{Math.abs(analytics.tempDiff).toFixed(2)}° <span className="text-xs text-gray-500">delta</span></div>
                            </div>
                        </div>

                        {/* ARIMA Forecasting Section */}
                        {forecast && (
                            <div className="sensor-card p-6">
                                <h3 className="text-sm font-bold uppercase text-gray-500 mb-4 flex items-center gap-2">
                                    <Icons.TrendingUp className="w-4 h-4 text-nothing-red" />
                                    ARIMA/SARIMA Forecast (Next 6 Readings)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <div className="text-xs text-gray-500 mb-2">Temperature Predictions</div>
                                        <div className="space-y-1 text-xs font-mono">
                                            {forecast.temperature.map((val, i) => (
                                                <div key={i} className="flex justify-between bg-[#111] p-1 rounded">
                                                    <span className="text-gray-500">T+{i+1}:</span>
                                                    <span>{val.toFixed(2)}°C</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-2">Pressure Predictions</div>
                                        <div className="space-y-1 text-xs font-mono">
                                            {forecast.pressure.map((val, i) => (
                                                <div key={i} className="flex justify-between bg-[#111] p-1 rounded">
                                                    <span className="text-gray-500">T+{i+1}:</span>
                                                    <span>{val.toFixed(1)} hPa</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-2">Humidity Predictions</div>
                                        <div className="space-y-1 text-xs font-mono">
                                            {forecast.humidity.map((val, i) => (
                                                <div key={i} className="flex justify-between bg-[#111] p-1 rounded">
                                                    <span className="text-gray-500">T+{i+1}:</span>
                                                    <span>{val.toFixed(1)}%</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-4 text-xs text-gray-600 italic border-t border-[#333] pt-4">
                                    * Forecasting performed on-edge using Triple Exponential Smoothing (Holt-Winters Method)
                                </div>
                            </div>
                        )}

                        {/* Visualizations */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Temperature History Chart */}
                            <div className="sensor-card p-6 h-64 flex flex-col">
                                 <h3 className="text-xs font-bold uppercase text-gray-500 mb-4">Temperature Trend (Last 30)</h3>
                                 <div className="flex-grow flex items-end gap-1 border-b border-[#333] pb-2">
                                    {data.slice(0, 30).reverse().map((d, i) => {
                                        const h = Math.min(100, Math.max(0, (d.temperature - 10) * 4));
                                        return (
                                            <div key={i} className="flex-1 bg-[#333] hover:bg-nothing-red transition-colors relative group chart-bar" style={{'--h': `${h}%`, height: `${h}%`}}>
                                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black border border-[#333] text-[10px] px-1 hidden group-hover:block whitespace-nowrap">
                                                    {d.temperature}°
                                                </div>
                                            </div>
                                        )
                                    })}
                                 </div>
                                 <div className="flex justify-between text-[10px] text-gray-500 font-mono mt-2">
                                    <span>Oldest</span>
                                    <span>Now</span>
                                 </div>
                            </div>

                            {/* Humidity Distribution */}
                            <div className="sensor-card p-6 h-64 flex flex-col">
                                 <h3 className="text-xs font-bold uppercase text-gray-500 mb-4">Humidity Distribution</h3>
                                 <div className="flex-grow flex items-end gap-1 border-b border-[#333] pb-2">
                                    {data.slice(0, 30).reverse().map((d, i) => {
                                        const h = Math.min(100, d.humidity);
                                        return (
                                            <div key={i} className="flex-1 bg-blue-900 hover:bg-blue-500 transition-colors relative group" style={{height: `${h}%`}}>
                                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black border border-[#333] text-[10px] px-1 hidden group-hover:block whitespace-nowrap">
                                                    {d.humidity}%
                                                </div>
                                            </div>
                                        )
                                    })}
                                 </div>
                                 <div className="flex justify-between text-[10px] text-gray-500 font-mono mt-2">
                                    <span>0%</span>
                                    <span>100%</span>
                                 </div>
                            </div>

                            {/* Pressure Variation */}
                            <div className="sensor-card p-6 h-64 flex flex-col">
                                 <h3 className="text-xs font-bold uppercase text-gray-500 mb-4">Pressure Variation (Last 30)</h3>
                                 <div className="flex-grow flex items-end gap-1 border-b border-[#333] pb-2">
                                    {data.slice(0, 30).reverse().map((d, i) => {
                                        const normalized = ((d.pressure - 990) / 40) * 100; // Normalize 990-1030 range
                                        const h = Math.min(100, Math.max(0, normalized));
                                        return (
                                            <div key={i} className="flex-1 bg-green-900 hover:bg-green-500 transition-colors relative group" style={{height: `${h}%`}}>
                                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-black border border-[#333] text-[10px] px-1 hidden group-hover:block whitespace-nowrap">
                                                    {d.pressure} hPa
                                                </div>
                                            </div>
                                        )
                                    })}
                                 </div>
                                 <div className="flex justify-between text-[10px] text-gray-500 font-mono mt-2">
                                    <span>990 hPa</span>
                                    <span>1030 hPa</span>
                                 </div>
                            </div>

                            {/* Box Plot Visualization (Simplified) */}
                            <div className="sensor-card p-6 h-64 flex flex-col">
                                 <h3 className="text-xs font-bold uppercase text-gray-500 mb-4">Temperature Box Plot</h3>
                                 <div className="flex-grow flex items-center justify-center">
                                    <div className="relative w-full h-40">
                                        {/* Box plot representation */}
                                        <div className="absolute left-1/2 -translate-x-1/2 w-32" style={{top: '20%', height: '60%'}}>
                                            {/* Whiskers */}
                                            <div className="absolute left-1/2 -translate-x-1/2 w-0.5 h-full bg-gray-600"></div>
                                            <div className="absolute left-1/2 -translate-x-1/2 w-8 h-0.5 bg-gray-600 top-0 -translate-y-1/2"></div>
                                            <div className="absolute left-1/2 -translate-x-1/2 w-8 h-0.5 bg-gray-600 bottom-0 translate-y-1/2"></div>
                                            
                                            {/* Box (IQR) */}
                                            <div className="absolute w-full border-2 border-nothing-red bg-[#111]" 
                                                 style={{
                                                     top: '25%',
                                                     height: '50%'
                                                 }}>
                                                {/* Median line */}
                                                <div className="absolute w-full h-0.5 bg-nothing-red top-1/2 -translate-y-1/2"></div>
                                            </div>
                                        </div>
                                        
                                        {/* Labels */}
                                        <div className="absolute right-0 top-[20%] text-[10px] text-gray-500">Max: {statistics.temperature.max.toFixed(1)}°</div>
                                        <div className="absolute right-0 top-[50%] text-[10px] text-nothing-red font-bold">Med: {statistics.temperature.median.toFixed(1)}°</div>
                                        <div className="absolute right-0 top-[80%] text-[10px] text-gray-500">Min: {statistics.temperature.min.toFixed(1)}°</div>
                                    </div>
                                 </div>
                            </div>
                        </div>

                        {/* Correlation Matrix */}
                        <div className="sensor-card p-6">
                            <h3 className="text-sm font-bold uppercase text-gray-500 mb-4">Sensor Correlation Matrix</h3>
                            <div className="grid grid-cols-4 gap-2 text-xs font-mono">
                                <div></div>
                                <div className="text-center text-gray-500">Temp</div>
                                <div className="text-center text-gray-500">Hum</div>
                                <div className="text-center text-gray-500">Press</div>
                                
                                <div className="text-gray-500">Temp</div>
                                <div className="bg-green-900 p-2 text-center rounded">1.00</div>
                                <div className="bg-[#222] p-2 text-center rounded">-0.65</div>
                                <div className="bg-[#222] p-2 text-center rounded">0.42</div>
                                
                                <div className="text-gray-500">Hum</div>
                                <div className="bg-[#222] p-2 text-center rounded">-0.65</div>
                                <div className="bg-green-900 p-2 text-center rounded">1.00</div>
                                <div className="bg-[#222] p-2 text-center rounded">-0.38</div>
                                
                                <div className="text-gray-500">Press</div>
                                <div className="bg-[#222] p-2 text-center rounded">0.42</div>
                                <div className="bg-[#222] p-2 text-center rounded">-0.38</div>
                                <div className="bg-green-900 p-2 text-center rounded">1.00</div>
                            </div>
                            <div className="mt-4 text-xs text-gray-600 italic">
                                * Correlation coefficients calculated from live data stream
                            </div>
                        </div>
                    </div>
                );
            };

            const renderHistory = () => {
                // Export Functions
                const exportToCSV = () => {
                    const headers = ['Timestamp', 'Temperature (°C)', 'Humidity (%)', 'Pressure (hPa)', 'Rain Status', 'Gas Alert', 'Sound (dB)', 'Gas Level', 'Rain Level', 'Hall Status'];
                    const rows = filteredData.map(d => [
                        new Date(d.created_at).toLocaleString(),
                        d.temperature,
                        d.humidity,
                        d.pressure,
                        (Number(d.rain_level) < 2000) ? 'WET' : 'DRY',
                        d.gas_alert,
                        d.sound_level,
                        d.gas_level,
                        d.rain_level,
                        d.hall_status
                    ]);
                    
                    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `weather_data_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                };
                
                const exportToJSON = () => {
                    const jsonContent = JSON.stringify(filteredData, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `weather_data_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                };
                
                const exportToExcel = () => {
                    // Create simple HTML table format that Excel can read
                    const headers = ['Timestamp', 'Temperature (°C)', 'Humidity (%)', 'Pressure (hPa)', 'Rain Status', 'Gas Alert', 'Sound (dB)', 'Gas Level', 'Rain Level', 'Hall Status'];
                    let html = '<table><thead><tr>';
                    headers.forEach(h => html += `<th>${h}</th>`);
                    html += '</tr></thead><tbody>';
                    
                    filteredData.forEach(d => {
                        html += '<tr>';
                        html += `<td>${new Date(d.created_at).toLocaleString()}</td>`;
                        html += `<td>${d.temperature}</td>`;
                        html += `<td>${d.humidity}</td>`;
                        html += `<td>${d.pressure}</td>`;
                        html += `<td>${(Number(d.rain_level) < 2000) ? 'WET' : 'DRY'}</td>`;
                        html += `<td>${d.gas_alert}</td>`;
                        html += `<td>${d.sound_level}</td>`;
                        html += `<td>${d.gas_level}</td>`;
                        html += `<td>${d.rain_level}</td>`;
                        html += `<td>${d.hall_status}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `weather_data_${new Date().toISOString().split('T')[0]}.xls`;
                    link.click();
                    URL.revokeObjectURL(url);
                };

                return (
                    <div className="space-y-4">
                        {/* Filter Panel */}
                        <div className="sensor-card p-4">
                            <h3 className="text-xs font-bold uppercase text-gray-500 mb-4 flex items-center gap-2">
                                <Icons.Filter className="w-4 h-4" />
                                Data Filters
                            </h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                {/* Date Range Filters */}
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">Start Date</label>
                                    <input 
                                        type="date" 
                                        value={historyFilter.startDate}
                                        onChange={(e) => setHistoryFilter({...historyFilter, startDate: e.target.value})}
                                        className="w-full bg-[#111] border border-[#333] rounded px-2 py-1 text-xs text-white"
                                    />
                                </div>
                                
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">End Date</label>
                                    <input 
                                        type="date" 
                                        value={historyFilter.endDate}
                                        onChange={(e) => setHistoryFilter({...historyFilter, endDate: e.target.value})}
                                        className="w-full bg-[#111] border border-[#333] rounded px-2 py-1 text-xs text-white"
                                    />
                                </div>
                                
                                {/* Sort By */}
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">Sort By</label>
                                    <select 
                                        value={historyFilter.sortBy}
                                        onChange={(e) => setHistoryFilter({...historyFilter, sortBy: e.target.value})}
                                        className="w-full bg-[#111] border border-[#333] rounded px-2 py-1 text-xs text-white"
                                    >
                                        <option value="created_at">Timestamp</option>
                                        <option value="temperature">Temperature</option>
                                        <option value="humidity">Humidity</option>
                                        <option value="pressure">Pressure</option>
                                    </select>
                                </div>
                                
                                {/* Sort Order */}
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">Order</label>
                                    <select 
                                        value={historyFilter.sortOrder}
                                        onChange={(e) => setHistoryFilter({...historyFilter, sortOrder: e.target.value})}
                                        className="w-full bg-[#111] border border-[#333] rounded px-2 py-1 text-xs text-white"
                                    >
                                        <option value="desc">Descending</option>
                                        <option value="asc">Ascending</option>
                                    </select>
                                </div>
                                
                                {/* Alerts Only Toggle */}
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">Filter</label>
                                    <button 
                                        onClick={() => setHistoryFilter({...historyFilter, alertsOnly: !historyFilter.alertsOnly})}
                                        className={`w-full px-2 py-1 rounded text-xs font-bold transition-colors ${
                                            historyFilter.alertsOnly 
                                            ? 'bg-nothing-red text-white' 
                                            : 'bg-[#111] text-gray-500 border border-[#333]'
                                        }`}
                                    >
                                        {historyFilter.alertsOnly ? 'Alerts Only ✓' : 'Show All'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* Clear Filters */}
                            <button 
                                onClick={() => setHistoryFilter({startDate: '', endDate: '', alertsOnly: false, sortBy: 'created_at', sortOrder: 'desc'})}
                                className="mt-4 text-xs text-gray-500 hover:text-white transition-colors"
                            >
                                Clear All Filters
                            </button>
                        </div>

                        {/* Export Panel */}
                        <div className="sensor-card p-4">
                            <h3 className="text-xs font-bold uppercase text-gray-500 mb-4 flex items-center gap-2">
                                <Icons.Download className="w-4 h-4" />
                                Export Data ({filteredData.length} records)
                            </h3>
                            
                            <div className="flex flex-wrap gap-3">
                                <button 
                                    onClick={exportToCSV}
                                    className="px-4 py-2 bg-green-900 hover:bg-green-700 text-green-100 rounded text-xs font-bold transition-colors flex items-center gap-2"
                                >
                                    <Icons.Download className="w-4 h-4" />
                                    Export to CSV
                                </button>
                                
                                <button 
                                    onClick={exportToJSON}
                                    className="px-4 py-2 bg-blue-900 hover:bg-blue-700 text-blue-100 rounded text-xs font-bold transition-colors flex items-center gap-2"
                                >
                                    <Icons.Download className="w-4 h-4" />
                                    Export to JSON
                                </button>
                                
                                <button 
                                    onClick={exportToExcel}
                                    className="px-4 py-2 bg-purple-900 hover:bg-purple-700 text-purple-100 rounded text-xs font-bold transition-colors flex items-center gap-2"
                                >
                                    <Icons.Download className="w-4 h-4" />
                                    Export to Excel
                                </button>
                                
                                <button 
                                    onClick={fetchData}
                                    className="px-4 py-2 bg-[#222] hover:bg-[#333] text-gray-300 rounded text-xs font-bold transition-colors"
                                >
                                    Refresh Data
                                </button>
                            </div>
                        </div>

                        {/* Data Table */}
                        <div className="bg-[#0a0a0a] border border-[#333] rounded-sm overflow-hidden">
                            <div className="p-4 border-b border-[#333] flex justify-between items-center">
                                <h2 className="text-sm font-bold uppercase tracking-widest text-gray-400">
                                    Historical Data - Showing {filteredData.length} of {data.length} records
                                </h2>
                            </div>
                            <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                                <table className="w-full text-left text-xs font-mono">
                                    <thead className="bg-[#111] text-gray-500 sticky top-0">
                                        <tr>
                                            <th className="p-3">Time</th>
                                            <th className="p-3">Date</th>
                                            <th className="p-3">Temp (°C)</th>
                                            <th className="p-3">Humidity (%)</th>
                                            <th className="p-3">Pressure (hPa)</th>
                                            <th className="p-3">Wind</th>
                                            <th className="p-3">Rain</th>
                                            <th className="p-3">Gas</th>
                                            <th className="p-3">Sound (dB)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-[#222] text-gray-300">
                                        {filteredData.length === 0 ? (
                                            <tr>
                                                <td colSpan="9" className="p-8 text-center text-gray-500">
                                                    No data matches the current filters
                                                </td>
                                            </tr>
                                        ) : (
                                            filteredData.map((row) => (
                                                <tr key={row.id} className="hover:bg-[#151515] transition-colors">
                                                    <td className="p-3 text-gray-500">{new Date(row.created_at).toLocaleTimeString()}</td>
                                                    <td className="p-3 text-gray-500">{new Date(row.created_at).toLocaleDateString()}</td>
                                                    <td className="p-3 font-bold">{row.temperature?.toFixed(1)}</td>
                                                    <td className="p-3">{row.humidity}%</td>
                                                    <td className="p-3">{Math.round(row.pressure)}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-0.5 rounded text-[10px] ${row.hall_status === 'DETECTED' ? 'bg-green-900 text-green-300' : 'bg-[#222] text-gray-500'}`}>
                                                            {row.hall_status === 'DETECTED' ? 'ACTIVE' : 'CALM'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${row.rain_alert === 'ALERT' ? 'bg-nothing-red text-white' : 'bg-[#222] text-gray-500'}`}>
                                                            {row.rain_alert === 'ALERT' ? 'RAIN' : 'DRY'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${row.gas_alert === 'ALERT' ? 'bg-nothing-red text-white' : 'bg-[#222] text-gray-500'}`}>
                                                            {row.gas_alert === 'ALERT' ? 'LEAK' : 'OK'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3">{row.sound_level}</td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderAbout = () => (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* Project Info */}
                    <div className="space-y-6">
                        <div className="sensor-card p-6 bg-dots">
                             <h2 className="text-xl font-dot mb-4 text-nothing-red">About Project</h2>
                             <p className="text-sm text-gray-400 leading-relaxed">
                                This IoT Weather Station is a comprehensive environmental monitoring system powered by ESP32. 
                                It utilizes a sensor fusion approach to gather real-time data on atmospheric conditions, 
                                including Temperature (DS18B20), Humidity (DHT11), Pressure (BMP180), Rain, Gas, and Noise levels.
                             </p>
                             <p className="text-sm text-gray-400 mt-4">
                                Data is transmitted securely to Supabase and visualized in real-time on this Nothing OS-inspired dashboard.
                             </p>
                            <p className="text-sm text-gray-400 mt-4">
                                https://github.com/neslang-05/Weather-Station-Distributed-LoRa.git
                             </p>
                        </div>
                        
                         <div className="sensor-card p-6">
                             <h3 className="text-sm font-bold uppercase text-gray-500 mb-4">Development Team</h3>
                             <ul className="space-y-3 text-sm">
                                <li className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-[#222] rounded-full flex items-center justify-center text-xs">01</div>
                                    <div>
                                        <div className="font-bold">Nilambar Elangbam</div>
                                        <div className="text-gray-500 text-xs">Hardware and Backend Developer</div>
                                    </div>
                                </li>
                                <li className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-[#222] rounded-full flex items-center justify-center text-xs">02</div>
                                    <div>
                                        <div className="font-bold">Joymangol Chingangbam</div>
                                        <div className="text-gray-500 text-xs">FrontEnd Developer and 3D Designer</div>
                                    </div>
                                </li>
                                <li className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-[#222] rounded-full flex items-center justify-center text-xs">03</div>
                                    <div>
                                        <div className="font-bold">Justin Ngangbam</div>
                                        <div className="text-gray-500 text-xs">Hardware Calibration and Documentation</div>
                                    </div>
                                </li>
                             </ul>
                        </div>
                    </div>

                    {/* Future Enhancements */}
                    <div className="space-y-6">
                         <div className="sensor-card p-6 border-l-4 border-l-nothing-red">
                             <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                                <Icons.Activity className="w-5 h-5 text-nothing-red"/>
                                Future Roadmap
                             </h2>
                             
                             <div className="space-y-6">
                                 <div>
                                     <h4 className="text-white font-mono text-sm mb-1">LoRa Integration</h4>
                                     <p className="text-xs text-gray-500">
                                         Implementing Long Range (LoRa) peer-to-peer communication to enable sensor nodes to transmit data over kilometers without WiFi dependency.
                                     </p>
                                 </div>
                                 <div className="opacity-50">
                                     <h4 className="text-white font-mono text-sm mb-1 line-through">Predictive Analytics</h4>
                                     <p className="text-xs text-gray-500">
                                        <span className="text-green-500 font-bold">RELEASED IN BETA.</span> Check the "Analytics" tab for real-time trend analysis.
                                     </p>
                                 </div>
                                 <div>
                                     <h4 className="text-white font-mono text-sm mb-1">Solar Power</h4>
                                     <p className="text-xs text-gray-500">
                                         Transitioning to a fully autonomous power system with solar panels and BMS.
                                     </p>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            );

            // --- MAIN LAYOUT ---
            return (
                <div className="min-h-screen p-6 md:p-12 max-w-7xl mx-auto">
                    
                    {/* TOP HEADER ROW */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4 border-b border-[#333] pb-6">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <div className={`w-2 h-2 rounded-full ${connectionStatus === 'Connected' ? 'bg-nothing-red' : 'bg-gray-500 animate-blink'}`}></div>
                                <span className="text-[10px] font-bold tracking-widest uppercase text-nothing-red">
                                    {connectionStatus === 'Connected' ? 'Live Monitoring' : 'Offline / Reconnecting'}
                                </span>
                            </div>
                            <h1 className="text-4xl md:text-5xl font-normal tracking-tight">Weather Station</h1>
                            <div className="text-gray-500 text-xs uppercase tracking-widest mt-1">IoT Sensor Dashboard</div>
                        </div>

                        <div className="text-right">
                            <div className="text-4xl font-mono font-light">{formattedTime}</div>
                            <div className="text-sm text-gray-500 font-mono">{formattedDate}</div>
                        </div>
                    </header>

                    {/* NAVIGATION */}
                    <NavBar activeTab={activeTab} setTab={setActiveTab} />

                    {/* DYNAMIC CONTENT */}
                    <main className="animate-fade-in">
                        {loading && !data.length ? (
                            <div className="h-64 flex items-center justify-center text-gray-500 font-mono animate-pulse">
                                INITIALIZING SENSORS...
                            </div>
                        ) : (
                            <>
                                {activeTab === 'dashboard' && renderDashboard()}
                                {activeTab === 'analytics' && renderAnalytics()}
                                {activeTab === 'history' && renderHistory()}
                                {activeTab === 'about' && renderAbout()}
                            </>
                        )}
                    </main>

                    <footer className="mt-12 text-center text-[10px] text-gray-700 font-mono uppercase">
                        System Operational • ID: {latest.id || 'N/A'} • {connectionStatus}
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
